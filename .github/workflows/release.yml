name: Release & Publish

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_to_playstore:
        description: 'Force Deploy to Play Store?'
        required: true
        type: boolean
        default: false
      track:
        description: 'Track (internal/alpha/beta/production)'
        required: true
        type: choice
        options:
          - internal
          - alpha
          - production
        default: 'internal'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. ðŸ§  SMART LOGIC: Detect if this is a Pre-release (RC) or Production
      - name: Check Tag Type
        id: check_tag
        run: |
          # If triggered by tag and contains a dash (e.g. v1.2.0-rc1), it is PRE-RELEASE
          if [[ "${{ github.ref_name }}" == *-* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "Status: Pre-release (RC/Fix detected)"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "Status: Production Release"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 2. ðŸ” KEYSTORE: Preserving your exact setup
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE }}
        run: |
          mkdir -p app
          echo "$KEYSTORE_BASE64" | base64 -d > app/aurelay-release.jks

      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=aurelay-release.jks
          EOF

      # 3. ðŸ“ CHANGELOG: Reads the exact section for this tag from CHANGELOG.md
      - name: Read Changelog
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: ${{ github.ref_name }}
          path: ./CHANGELOG.md
        continue-on-error: true # Prevents failure if you forget to update changelog for a quick RC fix

      # 4. ðŸ—ï¸ BUILD: Create the Bundle (AAB)
      - name: Build Release AAB
        run: ./gradlew bundleRelease

      # 5. ðŸ“¦ GITHUB RELEASE: Handles Assets + Prerelease logic automatically
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Aurelay ${{ github.ref_name }}
          # Use changelog if found, otherwise default text
          body: ${{ steps.changelog_reader.outputs.changes || 'Automated Release Build' }}
          files: |
            app/build/outputs/bundle/release/app-release.aab
          draft: false
          # Automatically marks as "Pre-release" if it's an RC tag
          prerelease: ${{ steps.check_tag.outputs.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. ðŸš€ PLAY STORE: Only runs if NOT pre-release OR forced via manual trigger
      - name: Upload to Play Store
        if: |
          (steps.check_tag.outputs.IS_PRERELEASE == 'false') || 
          (github.event_name == 'workflow_dispatch' && inputs.deploy_to_playstore == true)
        uses: r0adkll/upload-google-play@v1
        with:
          # We use your existing secret, just mapped to the new action input
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.devindeed.aurelay
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: ${{ inputs.track || 'internal' }}
          status: completed
          releaseName: ${{ github.ref_name }}
          # Uses the same changelog text for the Play Store "What's New" section
          whatsNewDirectory: distribution/whatsnew 
          # Or map text directly if prefered, but directory is standard for this action. 
          # For simplicity, we can let it use the GitHub body or skip mapping notes if folder is missing.

      # 7. ðŸ§¹ CLEANUP
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f app/aurelay-release.jks
          rm -f key.properties