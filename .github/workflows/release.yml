name: Release & Publish

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_to_playstore:
        description: 'Force Deploy to Play Store?'
        required: true
        type: boolean
        default: false
      track:
        description: 'Track (internal/alpha/beta/production)'
        required: true
        type: choice
        options: [internal, alpha, production]
        default: 'internal'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Logic: Detect RC vs Production
      - name: Check Tag Type
        id: check_tag
        run: |
          if [[ "${{ github.ref_name }}" == *-* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "Status: Pre-release (RC detected) -> GitHub APK Only"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "Status: Production Release -> GitHub APK + Play Store AAB"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle' # Critical for speed

      - name: Verify Java and stop Gradle daemons
        run: |
          echo "java version:" && java -version
          echo "JAVA_HOME=$JAVA_HOME"
          ./gradlew --stop || true

      - name: Pin Gradle Java home to runner JDK
        run: |
          echo "Ensuring gradle.properties points to runner JAVA_HOME: $JAVA_HOME"
          if [ -f gradle.properties ]; then
            if grep -q '^org.gradle.java.home=' gradle.properties; then
              sed -i "s|^org.gradle.java.home=.*|org.gradle.java.home=${JAVA_HOME}|" gradle.properties
            else
              echo "org.gradle.java.home=${JAVA_HOME}" >> gradle.properties
            fi
          else
            echo "org.gradle.java.home=${JAVA_HOME}" > gradle.properties
          fi
          ./gradlew --stop || true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE }}
        run: |
          mkdir -p app
          echo "$KEYSTORE_BASE64" | base64 -d > app/aurelay-release.jks

      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=aurelay-release.jks
          EOF

      - name: Read Changelog
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: ${{ github.ref_name }}
          path: ./CHANGELOG.md
        continue-on-error: true

      # 2. Build: Run BOTH tasks in one command to save overhead
      # assembleRelease = APK
      # bundleRelease = AAB
      - name: Build APK and AAB
        run: ./gradlew assembleRelease bundleRelease

      # 3. Rename APK for GitHub (aurelay-v1.2.0-release.apk)
      - name: Rename APK
        run: |
          # Find the default APK
          APK_PATH=app/build/outputs/apk/release/app-release.apk
          
          # Define new name
          NEW_NAME=app/build/outputs/apk/release/aurelay-${{ github.ref_name }}-release.apk
          
          # Rename
          echo "Renaming $APK_PATH to $NEW_NAME"
          mv $APK_PATH $NEW_NAME

      # 4. GitHub Release: Uploads ONLY the Renamed APK
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Aurelay ${{ github.ref_name }}
          body: ${{ steps.changelog_reader.outputs.changes || 'Automated Release Build' }}
          # Point explicitly to the NEW name
          files: app/build/outputs/apk/release/aurelay-${{ github.ref_name }}-release.apk
          draft: false
          prerelease: ${{ steps.check_tag.outputs.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. Play Store: Uploads ONLY the AAB (Original Name)
      - name: Upload to Play Store
        if: |
          (steps.check_tag.outputs.IS_PRERELEASE == 'false') || 
          (github.event_name == 'workflow_dispatch' && inputs.deploy_to_playstore == true)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.devindeed.aurelay
          # Point to the AAB (Standard name)
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: ${{ inputs.track || 'internal' }}
          status: completed
          releaseName: ${{ github.ref_name }}

      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f app/aurelay-release.jks
          rm -f key.properties